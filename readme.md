# مشروع التنبؤ بانسحاب العملاء (Customer Churn Prediction)

يهدف هذا المشروع إلى بناء نموذج تعلم آلة يتنبّأ باحتمالية انسحاب
المستخدمين (Churn) من منصة بث موسيقى تعتمد على نموذج الاشتراكات.\
المشروع يشمل معالجة البيانات، بناء نموذج، مراقبة انحراف البيانات، إعادة
التدريب، وتجهيز واجهة API، مع هيكلة احترافية وأدوات لضبط جودة الكود.

تم استخدام **النسخة المصغّرة** من بيانات الأحداث (event logs) كما ورد في
التكليف.

------------------------------------------------------------------------

## ١. نظرة عامة على الحل

يتبع المشروع خط معالجة (Pipeline) مكوّن من الخطوات التالية:

1.  **إنشاء التسمية (Labels)**\
    تحديد المستخدم المنسحب بالاعتماد على الحدث:
    `Cancellation Confirmation`.

2.  **استخراج الميزات (Feature Engineering)**\
    حساب ميزات سلوكية لكل مستخدم (مثل عدد الأغاني، عدد الجلسات،
    الإعلانات، الفنانين، النشاط الزمني...).

3.  **إعداد بيانات التدريب**\
    دمج الميزات مع التسمية في ملف واحد جاهز للنمذجة.

4.  **تدريب النموذج**\
    استخدام خوارزمية Random Forest مع تسجيل التجارب في MLflow.

5.  **تقديم النموذج عبر واجهة API**\
    باستخدام FastAPI لتوفير Endpoint للتنبؤ بانسحاب المستخدم.

6.  **مراقبة انحراف البيانات والمفاهيم (Data & Concept Drift)**\
    كشف التغيّر في توزيع البيانات أو تراجع أداء النموذج.

7.  **نظام إعادة التدريب (Retraining)**\
    إعادة تدريب النموذج عند الحاجة وحفظ إصدارات النماذج السابقة.

8.  **تهيئة المشروع (Packaging & Tooling)**\
    عبر Docker, Makefile, pre-commit, ruff, black لضمان تشغيل موحد وكود
    منظم.

------------------------------------------------------------------------

## ٢. هيكلة المشروع (Project Structure)

``` text
ml-churn-project/
│
├── api/
│   └── main.py                 # واجهة FastAPI
│
├── data/                       # ملفات البيانات (الخام / الوسيطة)
│
├── models/                     # النموذج المدرب وقائمة الأعمدة
│
├── notebooks/                  # دفاتر Jupyter للتحليل الأولي
│
├── retrain_history/            # تاريخ النماذج المعاد تدريبها
│
├── scripts/
│   ├── create_labels.py        # إنشاء التسمية (churn / non-churn)
│   ├── create_features.py      # استخراج الميزات السلوكية
│   ├── training_data.py        # دمج الميزات مع التسمية
│   ├── train_model.py          # تدريب النموذج الأساسي
│   ├── retrain.py              # نظام إعادة التدريب
│   ├── create_baseline_stats.py# إنشاء baseline لإحصائيات البيانات
│   └── monitor_drift.py        # مراقبة انحراف البيانات/المفاهيم
│
├── mlruns/                     # سجلات MLflow للتجارب
│
├── .pre-commit-config.yaml     # إعداد pre-commit (ruff, black, ... )
├── Dockerfile                  # إعداد صورة Docker
├── Makefile                    # أوامر مختصرة للمهام المتكررة
├── requirements.txt            # الحزم المطلوبة
└── README.md
```

------------------------------------------------------------------------

## ٣. المتطلبات (Requirements)

-   Python 3.10+
-   pip
-   (اختياري) Docker
-   (اختياري لكن مفضل) git, pre-commit

------------------------------------------------------------------------

## ٤. إعداد البيئة (Setup)

### ٤.١ إنشاء وتفعيل بيئة افتراضية

في ويندوز مع Git Bash:

``` bash
python -m venv .venv
source .venv/Scripts/activate
```

### ٤.٢ تثبيت الحزم

``` bash
pip install -r requirements.txt
```

------------------------------------------------------------------------

## ٥. خط معالجة البيانات (Data Pipeline)

### ٥.١ إنشاء التسمية (Labels)

يتم تحديد المستخدم المنسحب إذا ظهر له الحدث `Cancellation Confirmation`.

``` bash
python scripts/create_labels.py
```

### ٥.٢ استخراج الميزات (Feature Engineering)

حساب ميزات سلوكية لكل مستخدم، مثل:

-   عدد الجلسات
-   عدد الأغاني
-   عدد الإعلانات
-   عدد الفنانين الفريدين
-   عدد الأغاني الفريدة
-   عدد Thumbs Up / Thumbs Down
-   عدد أيام النشاط على المنصة
-   متوسط الأغاني لكل جلسة
-   متوسط الإعلانات لكل جلسة

``` bash
python scripts/create_features.py
```

### ٥.٣ تجهيز بيانات التدريب

دمج الميزات مع التسمية في ملف واحد (مثل `training_data.csv`):

``` bash
python scripts/training_data.py
```

------------------------------------------------------------------------

## ٦. تدريب النموذج (Model Training)

``` bash
python scripts/train_model.py
```

هذا السكربت يقوم بـ:

-   تقسيم البيانات إلى تدريب واختبار

-   تدريب نموذج **Random Forest**

-   حفظ النموذج في مجلد `models/`

-   حفظ قائمة الأعمدة المستخدمة في التدريب

-   إنشاء ملفات للأخطاء:

    -   `false_positive.csv`
    -   `false_negative.csv`

-   تسجيل التجربة في **MLflow** داخل مجلد `mlruns/`

------------------------------------------------------------------------

## ٧. نتائج النموذج (Model Performance)

على مجموعة الاختبار، كانت النتائج كالتالي:

### الفئة 0 (غير منسحب)

-   Precision: 0.90
-   Recall: 0.77
-   F1-score: 0.83

### الفئة 1 (منسحب)

-   Precision: 0.50
-   Recall: 0.73
-   F1-score: 0.59

### نتائج عامة

-   Accuracy: 0.76
-   Macro F1: 0.71
-   Weighted F1: 0.77

تم التركيز على **Recall للفئة 1** لأنها الأهم لاكتشاف المستخدمين
المعرّضين للانسحاب قبل حدوثه.

------------------------------------------------------------------------

## ٨. واجهة API (Serving via FastAPI)

### ٨.١ تشغيل الخادم (Server)

``` bash
uvicorn api.main:app --reload
```

### ٨.٢ Endpoint الأساسي

-   `POST /predict` يستقبل بيانات مستخدم (features) ويرجع:

-   `churn_prediction` (0 أو 1)

-   `churn_probability` (احتمالية الانسحاب)

### ٨.٣ مثال طلب (Request Example)

``` json
{
  "num_events": 216,
  "num_sessions": 5,
  "num_songs": 154,
  "num_ads": 18,
  "thumbs_up": 7,
  "thumbs_down": 3,
  "help_events": 2,
  "error_events": 0,
  "downgrade_events": 0,
  "distinct_artists": 149,
  "distinct_songs": 153,
  "is_paid": 0,
  "days_on_platform": 85,
  "activity_span_days": 18,
  "songs_per_session": 30.8,
  "ads_per_session": 3.6,
  "thumbs_up_ratio": 0.63
}
```

------------------------------------------------------------------------

## ٩. مراقبة الانحراف (Data & Concept Drift Monitoring)

### ٩.١ إنشاء baseline لإحصائيات البيانات

``` bash
python scripts/create_baseline_stats.py
```

### ٩.٢ تشغيل مراقبة انحراف البيانات

``` bash
python scripts/monitor_drift.py
```

### ٩.٣ Concept Drift

يتم تقدير انحراف المفهوم عن طريق مقارنة أداء النموذج الحالي على بيانات
جديدة.

------------------------------------------------------------------------

## ١٠. نظام إعادة التدريب (Retraining System)

``` bash
python scripts/retrain.py
```

------------------------------------------------------------------------


------------------------------------------------------------------------

# ٩. مراقبة انحراف البيانات والمفاهيم (Data & Concept Drift Monitoring)

## ٩.١ إنشاء baseline لإحصائيات البيانات

``` bash
python scripts/create_baseline_stats.py
```

يقوم هذا السكربت بحساب:

-   mean\
-   std\
-   min\
-   max

ويحفظها في ملف **baseline.json** لتمثيل الحالة الطبيعية للبيانات.

------------------------------------------------------------------------

## ٩.٢ تشغيل مراقبة انحراف البيانات

``` bash
python scripts/monitor_drift.py
```

يقوم السكربت بـ:

-   قراءة baseline المخزن\
-   حساب الإحصائيات الحالية\
-   مقارنة المتوسطات ونسب التغير\
-   تحديد الميزات التي تجاوزت عتبة معينة واعتبارها drifted

------------------------------------------------------------------------

## ٩.٣ انحراف المفهومConcept Drift

يتم تقدير انحراف المفهوم عبر:

-   مقارنة أداء النموذج الحالي بالنتائج التاريخية\
-   مراقبة انخفاض المقاييس (خاصة Recall للفئة 1)\
-   تفعيل إعادة التدريب عند تراجع الأداء تحت حد معين

------------------------------------------------------------------------

# ١٠. نظام إعادة التدريب (Retraining System)

لتشغيل إعادة التدريب:

``` bash
python scripts/retrain.py
```

يقوم النظام بـ:

-   تحميل البيانات الأحدث\
-   قياس أداء النموذج\
-   تدريب نموذج جديد عند الحاجة\
-   حفظ النماذج الجديدة داخل `retrain_history/`\
-   تسجيل العملية في MLflow

------------------------------------------------------------------------

# ١١. أدوات الجودة وتهيئة المشروع (Tooling & Packaging)

## ١١.١ Makefile

لتسهيل الأوامر:

``` bash
make train
make retrain
make api
make docker-build
```

------------------------------------------------------------------------

## ١١.٢ Docker

لبناء الصورة:

``` bash
make docker-build
```

------------------------------------------------------------------------

## ١١.٣ pre-commit, ruff, black

-   **ruff** -- فحص جودة الكود\
-   **black** -- تنسيق تلقائي\
-   **pre-commit** -- تشغيل الفحوص قبل أي commit
